---
layout:     post
title:      è®°å½•ä¸€æ¬¡blockç›¸å…³çš„å†…å­˜æ–°å‘ç°
subtitle:   è®°å½•ä¸€æ¬¡blockç›¸å…³çš„å†…å­˜æ–°å‘ç°
date:       2026-01-31
author:     LXY
header-img: img/home1.jpeg
catalog: true
tags:
    - iOS
---

# å‰è¨€

æˆ‘åœ¨åœ¨æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ä¼šæœ‰è¿™ç§å†™æ³•ï¼Œåœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å®ä¾‹åŒ–å‡ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ªblockï¼Œç­‰å¾…æ–¹æ³•å†…éƒ¨å¼‚æ­¥æ‰§è¡Œå®Œå›è°ƒï¼Œè¿™ç§å†™æ³•ç»å¸¸åº”ç”¨äºç½‘è·¯è¯·æ±‚ä¸­

## ç–‘é—®

ç”±äºæ­£å¸¸æƒ…å†µä¸‹æ–¹æ³•ä¸­å±€éƒ¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä½œç”¨åŸŸç»“æŸï¼Œé‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹æ–¹æ³•æ‰§è¡Œå®Œæˆ–è€…å¾ªç¯ç»“æŸä¸€æ¬¡ä¹‹åï¼Œå±€éƒ¨å˜é‡å˜é‡å°±ä¼šè¢«é‡Šæ”¾ï¼Œé‚£å²‚ä¸æ˜¯blockè¿˜æ²¡å›è°ƒï¼Œæ‰§è¡Œå¯¹è±¡å°±å·²ç»è¢«é‡Šæ”¾æ‰äº†ï¼Œè¿™æ—¶å€™æ–¹æ³•æ‰§è¡Œä¼šä¸ä¼šå‡ºé—®é¢˜ï¼Ÿblockæ˜¯å¦ä¹Ÿè¢«é‡Šæ”¾æ‰ï¼Œæ²¡åŠæ³•å›è°ƒï¼Ÿ

# å®éªŒä¸€

ç®€å•å†™ä¸€ä¸ªclassï¼Œæä¾›ä¸€ä¸ªå¼‚æ­¥å¸¦å›è°ƒçš„æ–¹æ³•:

```
typedef void(^ Callback)(NSString *st);

@interface BlockInfo : NSObject


- (void)request1:(Callback) callback;


@end

```

```
#import "BlockInfo.h"

@implementation BlockInfo


- (void)request1:(Callback) callback{
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(10 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        callback(@"ssss1");
    });
    
}

- (void)dealloc{
    NSLog(@"dealloc");
}

@end
```

æ–¹æ³•request1æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå»¶æ—¶10ç§’åç»™å‡ºå›è°ƒ

æ‰§è¡Œä¸‹é¢å®ç°ä»£ç ï¼š

```
- (void)test{
    for (int i=0; i<5; i++) {        
        BlockInfo *a = [BlockInfo new];
        __weak typeof(BlockInfo) *wa = a;
        [a request1:^(NSString * _Nonnull st) {
            NSLog(@"request1 === %@",wa);
        }];
        NSLog(@"for === end");
    }
}
```


**æ³¨æ„ï¼šä¸ºäº†å½±å“å±€éƒ¨å˜é‡çš„å¼•ç”¨è®¡æ•°ï¼Œè¿™é‡Œä½¿ç”¨çš„weakæ ‡è¯†!!!**

æ—¥å¿—å¦‚ä¸‹ï¼š

```
for === end
dealloc
for === end
dealloc
for === end
dealloc
for === end
dealloc
for === end
dealloc
request1 === (null)
request1 === (null)
request1 === (null)
request1 === (null)
request1 === (null)
```

ç”±æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œå±€éƒ¨å˜é‡ç¡®å®å‡ºäº†ä½œç”¨åŸŸå°±è¢«é‡Šæ”¾æ‰ï¼Œä½†æ˜¯æ²¡æœ‰å½±å“blockçš„æ‰§è¡Œï¼ŒblockæˆåŠŸæ‰§è¡Œäº†ï¼Œè°ƒç”¨å¯¹è±¡ä¹Ÿç¡®å®ä¸ºnull

# æ¢ç©¶ä¸€

**æ‰§è¡Œå¯¹è±¡å·²ç»è¢«é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆblockä¸ºä»€ä¹ˆä¼šè¢«æˆåŠŸæ‰§è¡Œï¼Ÿæ˜¯è°æŒæœ‰äº†blockï¼Ÿ**

ğŸ‘‰ å…¶å®æ˜¯åº•å±‚çš„å¼‚æ­¥ç³»ç»Ÿï¼ˆNSURLConnection / NSURLSession / GCD / runloopï¼‰åœ¨æŒæœ‰ blockï¼Œè¿™ç”¨ç¡®ä¿blockæˆåŠŸæ‰§è¡Œ

å®ä¾‹ä»£ç ä¸­å…¶å®å°±æ˜¯GCDåœ¨æŒæœ‰block



# å®éªŒäºŒ

ç»™BlockInfo classæ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œå±æ€§ä¸ºblockç±»å‹ï¼Œæ‰§è¡Œæ–¹æ³•çš„æ—¶å€™å»æŒæœ‰ä¼ è¿›æ¥çš„blockå˜é‡

```
#import <Foundation/Foundation.h>

NS_ASSUME_NONNULL_BEGIN

typedef void(^ Callback)(NSString *st);

@interface BlockInfo : NSObject


@property(nonatomic,copy) Callback callback;

- (void)request1:(Callback) callback;

- (void)request2:(Callback) callback;

@end

NS_ASSUME_NONNULL_END
```

```
#import "BlockInfo.h"

@implementation BlockInfo

- (void)request1:(Callback) callback{
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(10 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        callback(@"ssss1");
    });
}


- (void)request2:(Callback) callback{
    self.callback = callback;
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(10 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        self.callback(@"ssss2");
    });
}


- (void)dealloc {
    NSLog(@"dealloc");
}

@end

```

æ‰§è¡Œæ–°å®éªŒæ–¹æ³•request2

```
- (void)test{
    for (int i=0; i<5; i++) {
        BlockInfo *b = [BlockInfo new];
        __weak typeof(BlockInfo) *wb = b;
        [b request2:^(NSString * _Nonnull st) {
            NSLog(@"request2 === %@", wb);
        }];   
         NSLog(@"for === end");
            
    }
}
```

ç»“æœæ—¥å¿—å¦‚ä¸‹ï¼š

```
for === end
for === end
for === end
for === end
for === end
request2 === <BlockInfo: 0x600000014b90>
dealloc
request2 === <BlockInfo: 0x600000014d00>
dealloc
request2 === <BlockInfo: 0x600000014da0>
dealloc
request2 === <BlockInfo: 0x600000014e70>
dealloc
request2 === <BlockInfo: 0x600000014ee0>
dealloc
```

æ—¥å¿—ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå±€éƒ¨å®ä¾‹å˜é‡åœ¨æ‰§è¡Œblockä¹‹å‰å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œæ‰§è¡Œå®Œblockæ‰è¢«é‡Šæ”¾æ‰ï¼ŒblockæˆåŠŸæ‰§è¡Œè°ƒç”¨å¯¹è±¡ä¹Ÿç¡®å®ä¸ä¸ºnull


# æ¢ç©¶äºŒ

**æ‰§è¡Œå¯¹è±¡æ˜¯åœ¨æ‰§è¡Œå®Œblockåæ‰è¢«é‡Šæ”¾ï¼Œé‚£æ˜¯è°æŒæœ‰äº†è¿™ä¸ªå¯¹è±¡ï¼Ÿ**

ğŸ‘‰ å…¶å®åŒæ ·æ˜¯åº•å±‚çš„å¼‚æ­¥ç³»ç»Ÿï¼ˆNSURLConnection / NSURLSession / GCD / runloopï¼‰åœ¨æŒæœ‰ è¿™ä¸ªå¯¹è±¡ï¼Œåœ¨åº•å±‚å¼‚æ­¥ç³»ç»ŸæŒæœ‰blockçš„æ—¶å€™ä¼šåŒæ—¶æŒæœ‰å¯¹è±¡çš„æŒæœ‰è€…ï¼Œç›´åˆ°blockæ‰§è¡Œå®Œæ‰ä¼šè¢«é‡Šæ”¾
